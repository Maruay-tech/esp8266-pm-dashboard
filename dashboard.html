<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESP8266 PM2230 Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    canvas { width: 100%%; max-width: 600px; margin-bottom: 30px; }
    h2 { color: #333; }
  </style>
</head>
<body>
  <h2>üìä ESP8266 PM2230 Live Dashboard</h2>
  <p>Data from GitHub JSON: <span id="status">Loading...</span></p>
  <canvas id="voltageChart"></canvas>
  <canvas id="currentChart"></canvas>
  <canvas id="powerChart"></canvas>

  <script>
    const GITHUB_JSON_URL = "https://raw.githubusercontent.com/Maruay-tech/esp8266-dashboard/main/data/data.json";

    const voltageCtx = document.getElementById('voltageChart').getContext('2d');
    const currentCtx = document.getElementById('currentChart').getContext('2d');
    const powerCtx = document.getElementById('powerChart').getContext('2d');

    const voltageChart = new Chart(voltageCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Voltage (V)', data: [], borderColor: 'blue', tension: 0.3 }] }
    });

    const currentChart = new Chart(currentCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Current (A)', data: [], borderColor: 'green', tension: 0.3 }] }
    });

    const powerChart = new Chart(powerCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Power (kW)', data: [], borderColor: 'red', tension: 0.3 }] }
    });

    async function fetchData() {
      try {
        const res = await fetch(GITHUB_JSON_URL + "?t=" + new Date().getTime()); // prevent cache
        const json = await res.json();
        document.getElementById("status").innerText = "‚úî Updated";

        const now = new Date().toLocaleTimeString();

        [voltageChart, currentChart, powerChart].forEach(chart => {
          if (chart.data.labels.length > 20) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
          }
          chart.data.labels.push(now);
        });

        voltageChart.data.datasets[0].data.push(json.v1n || 0);
        currentChart.data.datasets[0].data.push(json.a1 || 0);
        powerChart.data.datasets[0].data.push(json.kw || 0);

        voltageChart.update();
        currentChart.update();
        powerChart.update();
      } catch (e) {
        document.getElementById("status").innerText = "‚ùå Failed to load data";
        console.error("Error loading JSON:", e);
      }
    }

    fetchData();
    setInterval(fetchData, 5000);
  </script>
</body>
</html>
