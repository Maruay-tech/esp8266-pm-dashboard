<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESP8266 PM2230 Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .card { border-radius: 15px; color: white; margin-bottom: 20px; }
    .bg-orange { background: linear-gradient(to right, #fc4a1a, #f7b733); }
    .bg-blue { background: linear-gradient(to right, #36d1dc, #5b86e5); }
    .bg-dark { background: #555; }
    .bg-red { background: linear-gradient(to right, #ff416c, #ff4b2b); }
    .bg-green { background: linear-gradient(to right, #00b09b, #96c93d); }
    .bg-purple { background: linear-gradient(to right, #6a11cb, #2575fc); }
    h5, .value-label { font-weight: bold; }
    .value-text { font-size: 1.5rem; }
  </style>
</head>
<body>
<div class="container py-4">
  <h3 class="mb-4">üìä ESP8266 PM2230 Dashboard (Live from GitHub)</h3>
  <div id="status" class="mb-3 text-muted">Loading data...</div>

  <div class="row" id="dashboard">
    <!-- Dynamic content -->
  </div>
</div>

<script>
const GITHUB_JSON_URL = "https://raw.githubusercontent.com/Maruay-tech/esp8266-pm-dashboard/main/data/data.json";

function createCard(title, values, colors) {
  return `
    <div class="col-md-4">
      <div class="card ${colors}">
        <div class="card-body">
          <h5 class="card-title">${title}</h5>
          ${values.map(v => `
            <div class="d-flex justify-content-between">
              <span class="value-label">${v.label}</span>
              <span class="value-text" id="${v.id}">--.--</span>
              <span>${v.unit}</span>
            </div>
          `).join("")}
        </div>
      </div>
    </div>
  `;
}

async function loadData() {
  try {
    const res = await fetch(GITHUB_JSON_URL + "?t=" + Date.now());
    const data = await res.json();
    document.getElementById("status").innerHTML = "‚úî Updated: " + new Date().toLocaleString();

    const content = `
      ${createCard("Voltage L-L", [
        { label: "Voltage LL1", id: "v12", unit: "Volt" },
        { label: "Voltage LL2", id: "v23", unit: "Volt" },
        { label: "Voltage LL3", id: "v31", unit: "Volt" }
      ], "bg-orange")}
      ${createCard("Voltage L-N", [
        { label: "Voltage LN1", id: "v1n", unit: "Volt" },
        { label: "Voltage LN2", id: "v2n", unit: "Volt" },
        { label: "Voltage LN3", id: "v3n", unit: "Volt" }
      ], "bg-orange")}
      ${createCard("Current", [
        { label: "Current 1", id: "a1", unit: "Amp" },
        { label: "Current 2", id: "a2", unit: "Amp" },
        { label: "Current 3", id: "a3", unit: "Amp" }
      ], "bg-yellow")}
      ${createCard("Power", [
        { label: "Power1", id: "kw1", unit: "kW" },
        { label: "Power2", id: "kw2", unit: "kW" },
        { label: "Power3", id: "kw3", unit: "kW" }
      ], "bg-red")}
      ${createCard("Total", [
        { label: "Total Power", id: "kw", unit: "kW" },
        { label: "EXP Energy", id: "exp", unit: "kWh" },
        { label: "IMP Energy", id: "imp", unit: "kWh" }
      ], "bg-blue")}
      ${createCard("Total Variable", [
        { label: "Frequency", id: "freq", unit: "Hz" },
        { label: "Total PF", id: "pf", unit: "" }
      ], "bg-green")}
      ${createCard("PF", [
        { label: "PF1", id: "pf1", unit: "" },
        { label: "PF2", id: "pf2", unit: "" },
        { label: "PF3", id: "pf3", unit: "" }
      ], "bg-purple")}
      ${createCard("Electricity Usage (kWh)", [
        { label: "Usage Today", id: "used_today", unit: "" },
        { label: "Usage This Month", id: "used_month", unit: "" }
      ], "bg-red")}
      ${createCard("Environment CO2", [
        { label: "CO2 Emission Today", id: "co2_today", unit: "Ton.CO2e" },
        { label: "CO2 Emission This Month", id: "co2_month", unit: "Ton.CO2e" },
        { label: "CO2 EF", id: "co2_ef", unit: "kg./kWh" }
      ], "bg-dark")}
    `;

    document.getElementById("dashboard").innerHTML = content;

    const mapping = {
      v12: data.v12, v23: data.v23, v31: data.v31,
      v1n: data.v1n, v2n: data.v2n, v3n: data.v3n,
      a1: data.a1, a2: data.a2, a3: data.a3,
      kw1: data.kw1, kw2: data.kw2, kw3: data.kw3,
      kw: data.kw, exp: data.exp, imp: data.imp,
      freq: data.freq, pf: data.pf,
      pf1: data.pf1, pf2: data.pf2, pf3: data.pf3,
      used_today: data.used_today, used_month: data.used_month,
      co2_today: data.co2_today, co2_month: data.co2_month, co2_ef: data.co2_ef
    };

    Object.entries(mapping).forEach(([id, val]) => {
      const el = document.getElementById(id);
      if (el) el.innerText = parseFloat(val || 0).toFixed(2);
    });

  } catch (err) {
    document.getElementById("status").innerText = "‚ùå Failed to load data.";
    console.error(err);
  }
}

loadData();
setInterval(loadData, 10000);
</script>
</body>
</html>
